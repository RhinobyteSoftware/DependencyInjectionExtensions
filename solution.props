<Project>

    <!-- SOLUTION WIDE CUSTOMIZATIONS HERE-->
    <PropertyGroup>
        <RepoRoot>$(MSBuildThisFileDirectory)</RepoRoot>
        <SolutionPropsIsImported>true</SolutionPropsIsImported>

        <DefaultTargetFrameworks>netstandard2.0;netstandard2.1;net48;netcoreapp3.1;net5.0</DefaultTargetFrameworks>
        <InternalMsbuildMessageImportance>normal</InternalMsbuildMessageImportance>
        <SolutionSummary>Extension libraries for the .NET</SolutionSummary>

        <AnalysisMode>AllEnabledByDefault</AnalysisMode>
        <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
        <EnableNETAnalyzers>true</EnableNETAnalyzers>
        <LangVersion>latest</LangVersion>
        <Nullable>enable</Nullable>
        <TreatWarningsAsErrors>true</TreatWarningsAsErrors>

        <!-- Common Package/Project Property Values -->
        <Authors>Ryan Thomas</Authors>
        <Company>Rhinobyte Software</Company>
        <Copyright>Copyright Â© Ryan Thomas $([System.DateTime]::Now.ToString("yyyy"))</Copyright>
        <EmbedUntrackedSources>true</EmbedUntrackedSources>
        <IncludeSymbols>true</IncludeSymbols>
        <NeutralLanguage>en-US</NeutralLanguage>
        <PackageIcon>Icon.png</PackageIcon>
        <PackageLicenseExpression>MIT</PackageLicenseExpression>
        <PackageOutputPath>$(RepoRoot)build\$(Configuration)\</PackageOutputPath>
        <PackageProjectUrl>https://github.com/RhinobyteSoftware/dotnet-extensions</PackageProjectUrl>
        <PublishRepositoryUrl>true</PublishRepositoryUrl>
        <RepositoryType>git</RepositoryType>
        <RepositoryUrl>https://github.com/RhinobyteSoftware/dotnet-extensions</RepositoryUrl>
        <SymbolPackageFormat>snupkg</SymbolPackageFormat>

        <!-- Subproject Package Versions -->
        <DataAnnotationsPackageVersion>1.0.0</DataAnnotationsPackageVersion>
        <DataAnnotationsPackageConsumerDependencyVersion>$([System.Text.RegularExpressions.Regex]::Replace('$(DataAnnotationsPackageVersion)', '(\d+\.\d+)\..+', '$1.0'))</DataAnnotationsPackageConsumerDependencyVersion>
        
        <DependencyInjectionPackageVersion>1.0.0</DependencyInjectionPackageVersion>
        <DependencyInjectionPackageConsumerDependencyVersion>$([System.Text.RegularExpressions.Regex]::Replace('$(DependencyInjectionPackageVersion)', '(\d+\.\d+)\..+', '$1.0'))</DependencyInjectionPackageConsumerDependencyVersion>
        
        <ReflectionPackageVersion>1.0.0</ReflectionPackageVersion>
        <ReflectionPackageConsumerDependencyVersion>$([System.Text.RegularExpressions.Regex]::Replace('$(ReflectionPackageVersion)', '(\d+\.\d+)\..+', '$1.0'))</ReflectionPackageConsumerDependencyVersion>
    </PropertyGroup>

    <Import Condition="Exists('$(RepoRoot)\development.props')" Project="$(RepoRoot)\development.props"/>

    <PropertyGroup Condition="'$(Configuration)' == 'Release'">
        <Optimize>true</Optimize>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="Microsoft.VisualStudio.Threading.Analyzers" Version="16.8.55">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
        </PackageReference>
    </ItemGroup>

    <ItemGroup>
        <AssemblyAttribute Include="System.Runtime.CompilerServices.InternalsVisibleTo">
            <_Parameter1>$(ProjectName).Tests</_Parameter1>
        </AssemblyAttribute>
        <AssemblyAttribute Include="System.Runtime.CompilerServices.InternalsVisibleTo">
            <_Parameter1>$(ProjectName).UnitTests</_Parameter1>
        </AssemblyAttribute>
    </ItemGroup>

    <ItemGroup Condition="'$(IsPackable)' == 'true'">
        <None Include="$(RepoRoot)\LICENSE.txt" Pack="true" PackagePath="LICENSE.txt" />
        <None Include="$(RepoRoot)\RhinobytePackageIcon.png" Pack="true" PackagePath="Icon.png" />
    </ItemGroup>


    <Target Name="CopyToLocalPackages" AfterTargets="Pack" Condition="'$(OutputToDevelopmentPackages)' == 'true' AND '$(IsPackable)' == 'true'">
        <Message Text="Creating DevelopmentPackagesDirectory: $(DevelopmentPackagesDirectory)" Condition="!Exists('$(DevelopmentPackagesDirectory)')" Importance="$(InternalMsbuildMessageImportance)" />
        <MakeDir Directories="$(DevelopmentPackagesDirectory)" Condition="!Exists('$(DevelopmentPackagesDirectory)')" />

        <Message Importance="$(InternalMsbuildMessageImportance)"
                 Text="
DevelopmentPackagesDirectory: $(DevelopmentPackagesDirectory)
PackageOutputPath: $(PackageOutputAbsolutePath)
PackageId: $(PackageId)
PackageVersion: $(PackageVersion)"  />

        <Exec Command="del $(PackageId).$(PackageVersion).*" WorkingDirectory="$(DevelopmentPackagesDirectory)" />

        <Copy SourceFiles="$(PackageOutputAbsolutePath)$(PackageId).$(PackageVersion).nupkg" DestinationFolder="$(DevelopmentPackagesDirectory)" />
    </Target>

    <Target Name="CreateDevelopmentProps" BeforeTargets="BeforeBuild" Condition="'$(Configuration)' != 'Release' AND Exists('$(RepoRoot)') AND !Exists('$(RepoRoot)\development.props')">
        <PropertyGroup>
            <RepoRootParent>$([System.IO.Path]::GetFullPath('$([System.IO.Path]::Combine('$(RepoRoot)', '..'))'))</RepoRootParent>
            <LocalPackagesPath Condition="'$(LocalPackagesPath)' == ''">$(RepoRootParent)\localPackages</LocalPackagesPath>
            <DevelopmentPropsFileLines>
&lt;Project&gt;
    &lt;PropertyGroup&gt;
        &lt;DevelopmentPackagesDirectory&gt;$(LocalPackagesPath)&lt;/DevelopmentPackagesDirectory&gt;
        &lt;!--  low, normal, or high --&gt;
        &lt;InternalMsbuildMessageImportance&gt;high&lt;/InternalMsbuildMessageImportance&gt;
        &lt;OutputToDevelopmentPackages&gt;false&lt;/OutputToDevelopmentPackages&gt;
        &lt;UseProjectReferences&gt;true&lt;/UseProjectReferences&gt;
    &lt;/PropertyGroup&gt;
&lt;/Project&gt;
            </DevelopmentPropsFileLines>
        </PropertyGroup>

        <Message Importance="$(InternalMsbuildMessageImportance)"
                 Text="
Creating default development.props file...

$(DevelopmentPropsFileLines)

RepoRoot: '$(RepoRoot)'
RepoRootParent: '$(RepoRootParent)'
LocalPackagesPath: '$(LocalPackagesPath)'
                " />

        <WriteLinesToFile File="$(RepoRoot)\development.props" Lines="$(DevelopmentPropsFileLines)" Overwrite="True" ContinueOnError="true" />
    </Target>

</Project>
